<!DOCTYPE html>
<html>
<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Voice Wall</title>
    <meta name="keywords" content="">
    <meta name="description" content="">

    <link href="lib/css/bootstrap.min.css" rel="stylesheet">
    <link href="lib/css/font-awesome.min.css" rel="stylesheet">

    <link href="lib/css/animate.min.css" rel="stylesheet">
    <link href="lib/css/style.min.css" rel="stylesheet">

</head>

<body class="white-bg">
	 
    <div class="row">
        <div class="col-sm-12">
        	<div class="ibox-content text-center noExtension hide" id="noExtension">
        		<h3>
	            NOTE: Please install <a target="_blank" href="https://github.com/ChengOrangeJu/WebExtensionWallet">
	            WebExtensionWallet</a>  to use Voice Wall
	            </h3>
	     	</div>
            <div class="wrapper wrapper-content">
                <ul class="notes" id = "block-wall">
                    <li>
                        <div>
                            <small>2018年5月7日  13:31</small>
                            <h4>天明</h4>
                            <p>今天天气不错！</p>
                            <a href=""><i class="fa fa-thumbs-up"></i></a>
                        </div>
                    </li>
                    <li>
                        <div>
                            <small>2018年5月7日  13:31</small>
                            <h4>少羽</h4>
                             <p>今天天气不错！</p>
                            <a href=""><i class="fa fa-thumbs-up "></i></a>
                        </div>
                    </li>
                    <li>
                        <div>
                           <small>2018年5月7日  13:31</small>
                            <h4>班大师</h4>
                             <p>今天天气不错！</p>
                            <a href=""><i class="fa fa-thumbs-up "></i></a>
                        </div>
                    </li>
                    <li>
                        <div>
                           <small>2018年5月7日  13:31</small>
                            <h4>某某某</h4>
                             <p>今天天气不错！</p>
                            <a href=""><i class="fa fa-thumbs-up "></i></a>
                        </div>
                    </li>
                    <li>
                        <div>
                            <small>2018年5月7日  13:31</small>
                            <h4>某某某</h4>
                             <p>今天天气不错！</p>
                            <a href=""><i class="fa fa-thumbs-up "></i></a>
                        </div>
                    </li>
                    <li>
                        <div>
                        	<h4>某某某</h4>
                            <small>2018年5月7日  13:31</small>
                            <p>某某某房间按时发来看的萨芬就离开第三放假啦开发 </p>
                            <a href=""><i class="fa fa-thumbs-up ">666</i></a>
                        </div>
                    </li>
                </ul>
                
            </div>
            
            <div class="ibox-content text-center">
            	<a class="btn btn-primary btn-rounded " id = "jumpWall">
         		<i class="fa fa-info-circle"></i> 我有话说，我要上墙</a>
         		
         		<a class="btn btn-primary btn-rounded" id = "wallInfo">
         		<i class="fa fa-info-circle"></i> 下一面墙</a>
         	</div>
        </div>
        
    </div>

    <script src="lib/jquery-3.3.1.min.js"></script>
    <script src="lib/bootstrap.min.js?v=3.3.6"></script>
    <script src=lib/nebPay.js></script>
    <script src=lib/dateFormat.js></script>
    <script type="text/javascript">
	    var NebPay = require("nebpay");     //https://github.com/nebulasio/nebPay
	    var nebPay = new NebPay();
	    
	    if (typeof(webExtensionWallet) === "undefined") {
            //alert ("Extension wallet is not installed, please install it first.")
            $("#noExtension").removeClass("hide")
        } else {
        	
        }
	    // 合约地址
	    var dappAddress = "n1oDUY9oFTkucgDwMWanCp1Z1yeBnxPsWBY";
	    // 抓取信息
	    function getWallInfo(limit, offset) {
	    	 var to = dappAddress;
	         var value = "0";
	         var callFunction = "forEach";
	         var callArgs = "[\"" + limit + "\",\"" + offset + "\"]"; //in the form of ["args"]
	         nebPay.simulateCall(to, value, callFunction, callArgs, {    //使用nebpay的simulateCall接口去执行get查询, 模拟执行.不发送交易,不上链
	             listener: handleResp      //指定回调函数
	         });
	    }
	    // 抓取信息响应
	    function handleResp(resp) {
	    	 var result = resp.result
	         console.log("return of rpc call: " + JSON.stringify(result))
	         if (result === 'null') {
	        	 // 空
	         } else {
	        	 var wall =  $("#block-wall");
	        	 wall.find("li").remove();
	        	 $.each(JSON.parse(result), function(idx, obj) {
	        		 console.log("return of rpc call: " + JSON.stringify(obj));
                 var item = "<li> <div> <small>发表于：" + obj.time
                 	+ "</small><h4>" + obj.nick + "</h4><p>"+ obj.msg 
                 	+ "</p> <a href=''> <i class='fa fa-thumbs-up '></i></a></div> </li>"
	        	 wall.append($(item));
	        	});
	         }
	         
	    }
	    // 上墙
	    function saveInfo(nick, msg, date) {
	    	 var to = dappAddress;
	         var value = "0";
	         var callFunction = "save"
	         var callArgs = "[\"" + nick + "\",\"" + msg + "\",\""  +date + "\"]"

	         nebPay.call(to, value, callFunction, callArgs, {    //使用nebpay的call接口去调用合约,
	             listener: pushWall
	         });
	    }
	    // 上墙保存信息回调
	    function pushWall(resp) {
	    	 console.log("response of push: " + JSON.stringify(resp));
	    }
	    // 我要上墙，直接保存操作
	    $("#jumpWall").click(function() {
	    	var date = getSmpFormatDate(new Date(), true); 
	    	console.log(date);
	    	saveInfo("八戒", "今天天气不错", date);
	    });
	    // 查询信息
	    $("#wallInfo").click(function() {
	    	console.log("get info****");
	    	getWallInfo("10", "0");
	    });
    </script>
</body>
</html>
