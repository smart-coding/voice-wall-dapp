<!DOCTYPE html>
<html>
<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Voice Wall</title>
    <meta name="keywords" content="">
    <meta name="description" content="">

    <link href="lib/css/bootstrap.min.css" rel="stylesheet">
    <link href="lib/css/font-awesome.min.css" rel="stylesheet">

    <link href="lib/css/animate.min.css" rel="stylesheet">
    <link href="lib/css/style.css" rel="stylesheet">
	<style type="text/css">
	
		body.bg {
			background: url(lib/img/background.jpg) no-repeat center fixed;
			background-size:100% 100%; 
		}
		
		#particles {
			position: fixed;
			top: 0px;
			left: 0px;
			height:100%;
			width:100%;
			z-index: -1;
		}
		.text-center h2{
			color: #333;
		}
		.pb10 {
			padding-bottom: 10px;
		}
		.pull-right{
			float: right!important;
			padding-right: 80px;
		}
		#mask{
			display: none;
			width: 100%;
			position: fixed;
			z-index: 99;
			height: 100%;
			background: rgba(51,122,183,1);
			opacity:0.6;
			filter:progid:DXImageTransform.Microsoft.gradient(startColors=#99000000, endColors=#99000000);
		}
  		.wallForm{
  			padding-top: 10px;
  		}
  		form .form-group{
  			margin-top: 10px;
  		}
  		#operateDiv button {
  			margin-right: 10px;
  		}
  		#operateDiv {
  			margin-bottom: 50px;
  		} 
  		.footer {position: relative; 
  			position:fixed;
  			top:100%;
  			width:100%;
  			height: 40px;  
  			clear:both;  
  			margin-left:0px;
  			margin-top: -40px; /* footer高度的负值 */ }
  		.notes li p { 
  			word-break:break-all; 
  		}
	</style>
</head>

<body class="white-bg bg">
	  <div id = "particles"></div>
	  <div class="mask" id ="mask">
         <div class="sk-spinner sk-spinner-wave" style="margin-top: 60px;">
             <div class="sk-rect1"></div>
             <div class="sk-rect2"></div>
             <div class="sk-rect3"></div>
             <div class="sk-rect4"></div>
             <div class="sk-rect5"></div>
         </div>
     </div>
    <div class="row">
        <div class="col-sm-12">
	     	<div  class="text-center" > 
	     		<h2>区块链留言墙</h2>
	     		<h4>区块链不会说谎，区块链不会遗忘，将你的心声刻录在区块链上。</h4>
	     	</div>
            <div class="wrapper wrapper-content">
                <ul class="notes" id = "block-wall">
                    <li>
                        <div>
                            <small>2018年5月7日  13:31</small>
                            <h4>留言墙的初衷</h4>
                            <p>区块链不会说谎，区块链不会遗忘，将你的心声刻录在区块链上。</p>
                            <a><i class="fa fa-user"></i></a>
                        </div>
                    </li>
                    <li>
                        <div>
                            <small>2018年5月7日  13:35</small>
                            <h4>使用说明1</h4>
                             <p>如果你看到了这条说明，这个是静态数据，非链上真实数据。弹出提示安装Chrome钱包插件请点窗体蓝色链接下载安装，并且创建主网钱包，才能看到链上的真实数据。</p>
                            <a><i class="fa fa-user "></i></a>
                        </div>
                    </li>
                    <li>
                        <div>
                           <small>2018年5月7日  13:36</small>
                            <h4>使用说明2</h4>
                             <p>您的NAS主网钱包需要有余额才能发表留言。</p>
                            <a><i class="fa fa-user "></i></a>
                        </div>
                    </li>
                    <li>
                        <div>
                           <small>2018年5月7日  13:37</small>
                            <h4>使用说明3</h4>
                             <p>点击我要上墙，填写信息，提交之后按照弹出的钱包提交交易即可。</p>
                            <a><i class="fa fa-user "></i></a>
                        </div>
                    </li>
                    <li>
                        <div>
                            <small>2018年5月7日  13:39</small>
                            <h4>使用说明4</h4>
                             <p>昵称不要超过32字符，想说的话不要超过128字符，请尽量精炼展示。</p>
                            <a><i class="fa fa-user "></i></a>
                        </div>
                    </li>
                    
                     <li>
                        <div>
                            <small>2018年5月7日  13:40</small>
                            <h4>使用说明5</h4>
                             <p>NAS目前交易的手续费是非常低的，一次留言大约只需花费0.00000002NAS手续费。</p>
                            <a><i class="fa fa-user "></i></a>
                        </div>
                    </li>
                     <li>
                        <div>
                            <small>2018年5月7日  13:41</small>
                            <h4>使用说明6</h4>
                             <p>欢迎大家体验，Dapp功能会持续上新，感谢支持！</p>
                            <a><i class="fa fa-user "></i></a>
                        </div>
                    </li>
                     <li>
                        <div>
                            <small>2018年5月7日  13:42</small>
                            <h4>致谢</h4>
                             <p>新上Jquery粒子系统插件效果，感谢https://github.com/jnicol/particleground</p>
                            <a><i class="fa fa-thumbs-up "></i></a>
                        </div>
                    </li>
                     <li>
                        <div>
                            <small>2018年5月7日  13:41</small>
                            <h4>天明</h4>
                             <p>今天天气不错！</p>
                            <a><i class="fa fa-user "></i></a>
                        </div>
                    </li>
                    
                    <li>
                        <div>
                        	<h4>少羽</h4>
                            <small>2018年5月7日  13:41</small>
                            <p>今天心情不错！ </p>
                            <a><i class="fa fa-user "></i></a>
                        </div>
                    </li>
                </ul>
                
            </div>
        </div>
        
        <div class="text-center pb10" id = "operateDiv">
           	<button class="btn btn-primary btn-rounded " id = "jumpWall">
        		<i class="fa fa-info-circle"></i> 我要上墙</button>
        		
        		<button class="btn btn-primary btn-rounded" id = "lastWallInfo">
        		<i class="fa fa-arrow-circle-left"></i> 上一面墙</button>
        		
        		<button class="btn btn-primary btn-rounded" id = "nextWallInfo">
        		<i class="fa fa-arrow-circle-right"></i> 下一面墙</button>
        		
        		<!-- <a class="btn btn-primary btn-rounded" id = "newestWallInfo">
        		<i class="fa fa-joomla"></i> 最后一墙</a> -->
        		
        		<a class="btn btn-primary btn-rounded" id = "total">
        			<i class='fa fa-calculator'></i>
        		</a>
        		
        </div>
        
    </div>
	 <div class="footer">
         <div class="pull-right">
             NAS钱包打赏：<a>n1To7R91FvZZttm6HDLBhoMTkHVbkVrFvTo</a> &copy; 2018-2020 <a href="https://github.com/smart-coding" target="blank">Github联系我</a>
         </div>
	 </div>
    <script src="lib/jquery-3.3.1.min.js"></script>
    <script src="lib/bootstrap.min.js?v=3.3.6"></script>
    <script src=lib/nebPay.js></script>
    <script src=lib/dateFormat.js></script>
    <script src="lib/plugin/layer/layer.js"></script>
    <script src="lib/plugin/particleground/jquery.particleground.min.js"></script>
    <script type="text/javascript">
		$("#particles").particleground({
		    dotColor: "#cccc99",
		    lineColor: "#99cccc",
		    particleRadius: 5,
		    proximity: 60
		});
	    var NebPay = require("nebpay");
	    var nebPay = new NebPay();
	    
	    var page = 1;
	    if (typeof(webExtensionWallet) === "undefined") {
	    	// 提示信息
	    	 var info = "请使用Chrome浏览器并安装 <a target='_blank' href='https://github.com/ChengOrangeJu/WebExtensionWallet'>"
        		+ "星云链钱包插件(WebExtensionWallet)</a>  然后体验本Dapp。"
       		layer.open({
       			  title: '使用说明'
       			  ,content: info
       			});   
            $(".btn").attr("disabled",true);
        } else {
        	$("#mask").show();
        }
	    // 合约地址
	    var dappAddress = "n1h83E7TPATtEp7tJJqspQx8q5SApkdeTgu";
	    // 抓取信息
	    function getWallInfo(limit, offset) {
	    	 var to = dappAddress;
	         var value = "0";
	         var callFunction = "forEach";
	         var callArgs = "[\"" + limit + "\",\"" + offset + "\"]"; //in the form of ["args"]
	         //console.log("callArgs:" + callArgs);
	         nebPay.simulateCall(to, value, callFunction, callArgs, {    //使用nebpay的simulateCall接口去执行get查询, 模拟执行.不发送交易,不上链
	             listener: handleResp      //指定回调函数
	         });
	    }
	    // 抓取信息响应
	    function handleResp(resp) {
	    	 var wall =  $("#block-wall");
	    	 wall.find("li").remove();
	    	 var res = resp.result;
	    	 console.log("return of rpc call: " + JSON.stringify(res));
	    	 res = JSON.parse(res);
	    	 if (res === 'null') {
	    		 $("#mask").hide()
	    		 layer.alert('未获取到任何结果，一会儿再试试吧。', {icon: 6});
	    		 return false;
	    	 }
	    	 var result = res.data;
	    	 if (result === 'null' || result == "[]" || result == "") {
	        	 // 空数据
	        	 $("#mask").hide();
	        	 layer.alert('未获取到任何结果，一会儿再试试吧。', {icon: 5});
	        	 return false;
	         } else {
	        	 var total = res.total;
	        	 //result = JSON.parse(result);
	        	 console.log("return result: " + result);
	        	 var currMount = 0;
	        	 $.each(result, function(idx, obj) {
	        	 console.log("return of rpc call: " + JSON.stringify(obj));
                 var item = "<li> <div> <small>发表于：" + obj.time
                 	+ "</small><h4>" + obj.nick + "</h4><p>"+ obj.msg 
                 	+ "</p> <a title='from:" + obj.author 
                 	+"'> <i class='fa fa-user'></i></a></div> </li>"
	        	 wall.append($(item));
                 currMount++;
	        	});
	        	if (!total) {
	        		total = 0;
	        	}
	        	if (page < 1) {
	        		page = 1;
	        	}
	        	if (total <= ((page-1) * 10 + currMount)) {
	        		$("#nextWallInfo").attr("disabled",true);
	        	} else {
	        		$("#nextWallInfo").attr("disabled",false);
	        	}
	        	if (page == 1) {
	        		$("#lastWallInfo").attr("disabled",true);
	        		//$("#newestWallInfo").attr("disabled",true);
	        	}
	        	$("#total").html("<i class='fa fa-calculator'></i> total:" + total + " &nbsp page:" + page);
	        	$("#mask").hide()
	         }
	    }
	    // 上墙
	    function saveInfo(nick, msg, date) {
	    	 var to = dappAddress;
	         var value = "0";
	         var callFunction = "save"
	         var callArgs = "[\"" + nick + "\",\"" + msg + "\",\""  +date + "\"]"

	         nebPay.call(to, value, callFunction, callArgs, {    //使用nebpay的call接口去调用合约,
	             listener: pushWall
	         });
	    }
	    // 上墙保存信息回调
	    function pushWall(resp) {
	    	 //console.log("response of push: " + JSON.stringify(resp));
	    	 layer.alert('操作已完成，区块链矿工打包需要时间，请稍后刷新翻阅。', {icon: 6});
	    }
	    // 我要上墙，直接保存操作
	    $("#jumpWall").click(function() {
	    	var html = "<div class='form-group' style='margin-top: 15px'>"
            			+"<label class='col-sm-3 control-label'>昵称：</label>"
            			+"<div class='col-sm-8'>"
                		+"<input type='text' placeholder='输入你的昵称' class='form-control' id ='nick'>"
            			+"</div></div>"
				        +"<div class='form-group' style='margin-top: 65px'>"
				        +"<label class='col-sm-3 control-label'>我想说：</label>"
				        +"<div class='col-sm-8'>"
				        +"<textarea name = 'msg' class='form-control' id = 'msg'></textarea>"
				        +"</div></div>";
	    	layer.open({
	    		  title:"填写信息",
	    		  type: 1,
	    		  skin: 'layui-layer-rim', //加上边框
	    		  area: ['400px', '250px'], //宽高
	    		  content: html,
	    		  btnAlign: 'c',
	    		  btn:["提交"],
	    		  yes: function(index, layero){
	    			  var nick = $("#nick").val();
	    			  var msg = $("#msg").val();
	    			  console.log("nick:" + nick + "msg:" + msg);
	    			  if (!nick) {
	    				  layer.tips('昵称不能为空', '#nick');
	    				  return false;
	    			  }
	    			  if (nick.length > 32) {
	    				  layer.tips('昵称不能超过32字符', '#nick');
	    				  return false;
	    			  }
	    			  if (!msg) {
	    				  layer.tips('至少填点什么吧', '#msg');
	    				  return false;
	    			  }
	    			  if (msg.length > 128) {
	    				  layer.tips('填写内容不能超过128字符', '#msg');
	    				  return false;
	    			  }
	    			  var date = getSmpFormatDate(new Date(), true); 
	    			  saveInfo(nick, msg, date);
	    			  layer.closeAll();
	    			}
	    		});
	    });
	    // 上一墙
	    $("#lastWallInfo").click(function() {
	    	$("#mask").show();
	    	if (page > 1) {
	    		page = page - 1;
	    	}
	    	if (page < 1) {
	    		page = 1;
	    	}
	    	getWallInfo(page*10, (page-1) * 10);
	    	
	    });
	    // 后一墙
	    $("#nextWallInfo").click(function() {
	    	$("#mask").show();
	    	page = page + 1;
	    	getWallInfo(page*10, (page-1) * 10);
	    	$("#lastWallInfo").attr("disabled",false);
	    });
	    getWallInfo(10, 0);
    </script>
</body>
</html>
